name: Preview Env (Railway)

# Vercel-style previews: create/update a Railway preview environment for each PR into `staging`,
# then delete it when the PR is closed.
#
# Guide: https://github.com/marketplace/actions/railway-preview-deploy-action
on:
  pull_request:
    branches:
      - staging
    types: [opened, synchronize, reopened, closed]

concurrency:
  # Prevent overlapping deploys for the same PR.
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: ${{ github.event.action != 'closed' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify required Railway secrets are configured
        env:
          # Prefer the marketplace guide's secret name, but keep backward compatibility.
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN || secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          if [ -z "${RAILWAY_API_TOKEN}" ]; then
            echo "Missing GitHub Actions secret: RAILWAY_API_TOKEN (or legacy RAILWAY_TOKEN)" >&2
            exit 1
          fi
          if [ -z "${RAILWAY_PROJECT_ID}" ]; then
            echo "Missing GitHub Actions secret: RAILWAY_PROJECT_ID" >&2
            exit 1
          fi

      - name: Railway token diagnostics (safe)
        env:
          # Never print the token itself; only print metadata to catch copy/paste issues.
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN || secrets.RAILWAY_TOKEN }}
        run: |
          echo "railway_api_token_length=${#RAILWAY_API_TOKEN}"
          if [[ "$RAILWAY_API_TOKEN" =~ [[:space:]] ]]; then
            echo "railway_api_token_contains_whitespace=true"
          else
            echo "railway_api_token_contains_whitespace=false"
          fi

      - name: Deploy Railway preview environment
        id: deploy
        uses: ayungavis/railway-preview-deploy@v1.0.2
        with:
          railway_api_token: ${{ secrets.RAILWAY_API_TOKEN || secrets.RAILWAY_TOKEN }}
          project_id: ${{ secrets.RAILWAY_PROJECT_ID }}
          environment_name: staging
          # Stable, short name: avoids collisions and truncation issues from long branch names.
          preview_environment_name: pr-${{ github.event.pull_request.number }}
          # Used by the action to associate the preview env with the PR branch.
          branch_name: ${{ github.head_ref }}
          # Set project-level env vars used by frontend in preview env.
          # Backend will simply ignore unknown vars.
          environment_variables: '{"API_URL":"http://backend.railway.internal:8000"}'
          # Optional: help the action produce a URL output (our project uses `frontend` service as UI).
          api_service_name: frontend
          cleanup: 'false'

      - name: Print preview URL (if available)
        if: ${{ steps.deploy.outputs.service_domain != '' }}
        run: |
          echo "Preview URL: https://${{ steps.deploy.outputs.service_domain }}"

  cleanup-preview:
    runs-on: ubuntu-latest
    if: ${{ github.event.action == 'closed' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify required Railway secrets are configured
        env:
          # Prefer the marketplace guide's secret name, but keep backward compatibility.
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN || secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          if [ -z "${RAILWAY_API_TOKEN}" ]; then
            echo "Missing GitHub Actions secret: RAILWAY_API_TOKEN (or legacy RAILWAY_TOKEN)" >&2
            exit 1
          fi
          if [ -z "${RAILWAY_PROJECT_ID}" ]; then
            echo "Missing GitHub Actions secret: RAILWAY_PROJECT_ID" >&2
            exit 1
          fi

      - name: Cleanup Railway preview environment
        uses: ayungavis/railway-preview-deploy@v1.0.2
        with:
          railway_api_token: ${{ secrets.RAILWAY_API_TOKEN || secrets.RAILWAY_TOKEN }}
          project_id: ${{ secrets.RAILWAY_PROJECT_ID }}
          environment_name: staging
          preview_environment_name: pr-${{ github.event.pull_request.number }}
          branch_name: ${{ github.event.pull_request.head.ref }}
          cleanup: 'true'


